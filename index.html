<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invigilation Timetable Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="p-6 bg-gray-100">
  <h1 class="text-2xl font-bold mb-4">Invigilation Timetable Generator</h1>

  <!-- Inputs -->
  <div class="grid grid-cols-2 gap-4 mb-6">
    <div>
      <label class="block mb-1 font-semibold">Exam Date</label>
      <input type="text" id="examDate" placeholder="dd-mm-yyyy"
             class="border p-2 w-full rounded">
    </div>
    <div>
      <label class="block mb-1 font-semibold">Exam Start Time</label>
      <input type="text" id="examStart" placeholder="HHMM (24h, no colon)"
             class="border p-2 w-full rounded">
    </div>
    <div>
      <label class="block mb-1 font-semibold">Paper Duration (min)</label>
      <input type="number" id="examDuration" class="border p-2 w-full rounded">
    </div>
    <div>
      <label class="block mb-1 font-semibold">Shift Length (min)</label>
      <input type="number" id="shiftLength" class="border p-2 w-full rounded">
    </div>
  </div>

  <div class="mb-6">
    <label class="block mb-1 font-semibold">Invigilators (comma separated)</label>
    <textarea id="invigilators" rows="3" class="border p-2 w-full rounded"></textarea>
  </div>

  <div class="mb-6">
    <label class="block mb-1 font-semibold">Rooms (format: Name,Candidates,Extras)</label>
    <textarea id="rooms" rows="3" class="border p-2 w-full rounded"
              placeholder="Hall A,200,2&#10;Hall B,80,0"></textarea>
  </div>

  <div class="flex space-x-4 mb-6">
    <button onclick="generateTimetable()"
            class="bg-blue-600 text-white px-4 py-2 rounded">Generate</button>
    <button onclick="exportExcel()"
            class="bg-green-600 text-white px-4 py-2 rounded">Export Excel</button>
  </div>

  <!-- Output -->
  <div id="output" class="overflow-x-auto"></div>

<script>
function parseTime(str) {
  let h = parseInt(str.substring(0,2), 10);
  let m = parseInt(str.substring(2), 10);
  return h*60 + m;
}
function formatTime(totalMin) {
  let h = Math.floor(totalMin/60);
  let m = totalMin % 60;
  return (h<10?"0"+h:h) + (m<10?"0"+m:m);
}

function generateTimetable() {
  const date = document.getElementById("examDate").value.trim();
  const startTime = document.getElementById("examStart").value.trim();
  const examDuration = parseInt(document.getElementById("examDuration").value, 10);
  const shiftLength = parseInt(document.getElementById("shiftLength").value, 10);
  const invigilators = document.getElementById("invigilators").value.split(",").map(x => x.trim()).filter(Boolean);
  const roomsInput = document.getElementById("rooms").value.trim().split("\n");

  let rooms = [];
  for (let line of roomsInput) {
    let [name,cands,extra] = line.split(",");
    if (!name) continue;
    let candidates = parseInt(cands,10)||0;
    let extras = parseInt(extra,10)||0;
    let minReq = Math.ceil(candidates/40);
    rooms.push({name:name.trim(), candidates, extras, minReq, baseline:minReq+extras});
  }

  let startMin = parseTime(startTime);
  let numShifts = Math.ceil(examDuration/shiftLength);
  let shifts = [];
  for (let i=0;i<numShifts;i++) {
    let s = startMin + i*shiftLength;
    let e = Math.min(startMin + (i+1)*shiftLength, startMin+examDuration);
    shifts.push({start:s, end:e});
  }

  let assignment = {};
  rooms.forEach(r=>{
    assignment[r.name] = Array(numShifts).fill(null).map(()=>[]);
    // fixed start/end groups
    let fixedTeam = invigilators.splice(0,r.baseline);
    assignment[r.name][0] = [...fixedTeam]; 
    assignment[r.name][numShifts-1] = [...fixedTeam];

    // pool for middle rotation = remaining invigilators + fixed team (recycled)
    let pool = [...invigilators, ...fixedTeam];
    let index = 0;
    for (let s=1;s<numShifts-1;s++) {
      let group = [];
      for (let k=0;k<r.minReq;k++) {
        group.push(pool[index % pool.length]);
        index++;
      }
      assignment[r.name][s] = group;
    }
  });

  // Render
  let table = "<table class='table-auto border-collapse border border-gray-400 w-full bg-white'>";
  table += "<thead><tr><th class='border px-2 py-1'>Date</th><th class='border px-2 py-1'>Time</th>";
  rooms.forEach(r=>{table+="<th class='border px-2 py-1'>"+r.name+"</th>";});
  table+="</tr></thead><tbody>";

  shifts.forEach((shift,i)=>{
    table+="<tr><td class='border px-2 py-1'>"+date+"</td>";
    table+="<td class='border px-2 py-1'>"+formatTime(shift.start)+"-"+formatTime(shift.end)+"</td>";
    rooms.forEach(r=>{
      let names = assignment[r.name][i].join("<br>");
      table+="<td class='border px-2 py-1 align-top'>"+names+"</td>";
    });
    table+="</tr>";
  });

  table+="</tbody></table>";
  document.getElementById("output").innerHTML=table;
}

function exportExcel() {
  const table = document.querySelector("#output table");
  if (!table) {alert("Generate timetable first!");return;}
  const wb = XLSX.utils.table_to_book(table, {sheet:"Timetable"});
  XLSX.writeFile(wb,"invigilation_timetable.xlsx");
}
</script>
</body>
</html>
