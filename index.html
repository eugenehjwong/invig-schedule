<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invigilation Timetable Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-100">
  <h1 class="text-2xl font-bold mb-4">Invigilation Timetable Generator</h1>

  <!-- Inputs -->
  <div class="grid grid-cols-2 gap-4 mb-4">
    <div>
      <label class="block font-semibold">Date (dd-mm-yyyy)</label>
      <input id="date" type="text" placeholder="05-10-2025" class="w-full border rounded p-2">
    </div>
    <div>
      <label class="block font-semibold">Paper Start Time (HHMM 24h)</label>
      <input id="startTime" type="text" placeholder="0900" class="w-full border rounded p-2">
    </div>
    <div>
      <label class="block font-semibold">Paper Duration (minutes)</label>
      <input id="duration" type="number" placeholder="180" class="w-full border rounded p-2">
    </div>
    <div>
      <label class="block font-semibold">Shift Length (minutes)</label>
      <input id="shiftLength" type="number" placeholder="90" class="w-full border rounded p-2">
    </div>
  </div>

  <div class="mb-4">
    <label class="block font-semibold">Rooms (format: RoomName,Candidates,ExtraInvigilators)</label>
    <textarea id="rooms" rows="3" placeholder="Hall A,200,2&#10;Hall B,80,0" class="w-full border rounded p-2"></textarea>
  </div>

  <div class="mb-4">
    <label class="block font-semibold">Invigilators (comma separated)</label>
    <textarea id="invigilators" rows="2" placeholder="Alice,Bob,Chen,Deepa,Evan,Farah,George,Hana,Irene,Jack" class="w-full border rounded p-2"></textarea>
  </div>

  <div class="flex gap-4 mb-6">
    <button onclick="generateTimetable()" class="bg-blue-500 text-white px-4 py-2 rounded">Generate Timetable</button>
    <button onclick="exportExcel()" class="bg-green-500 text-white px-4 py-2 rounded">Export to Excel</button>
  </div>

  <div id="output"></div>

<script>
function formatTime(hhmm, addMinutes) {
  let h = parseInt(hhmm.slice(0,2));
  let m = parseInt(hhmm.slice(2));
  let total = h * 60 + m + addMinutes;
  let nh = Math.floor(total / 60) % 24;
  let nm = total % 60;
  return (nh < 10 ? "0" : "") + nh + (nm < 10 ? "0" : "") + nm;
}

let lastSchedule = [];

function generateTimetable() {
  const date = document.getElementById("date").value.trim();
  const startTime = document.getElementById("startTime").value.trim();
  const duration = parseInt(document.getElementById("duration").value);
  const shiftLength = parseInt(document.getElementById("shiftLength").value);
  const rooms = document.getElementById("rooms").value.trim().split("\n").map(r => r.split(","));
  const invigilators = document.getElementById("invigilators").value.trim().split(",").map(i => i.trim());

  if (!date || !startTime || !duration || !shiftLength || rooms.length === 0 || invigilators.length === 0) {
    alert("Please fill in all inputs.");
    return;
  }

  const numShifts = Math.ceil(duration / shiftLength);
  let schedule = [];
  let invIndex = 0;

  rooms.forEach(room => {
    let name = room[0].trim();
    let candidates = parseInt(room[1]);
    let extra = parseInt(room[2] || "0");
    let minInv = Math.ceil(candidates / 40);
    let baseline = minInv + extra;

    // pick start/end team (fixed set)
    let startEndTeam = [];
    for (let i = 0; i < baseline; i++) {
      startEndTeam.push(invigilators[(invIndex + i) % invigilators.length]);
    }
    invIndex += baseline;

    for (let s = 0; s < numShifts; s++) {
      let shiftStart = formatTime(startTime, s * shiftLength);
      let shiftEnd = formatTime(startTime, (s+1) * shiftLength);

      let team = [];
      if (s === 0 || s === numShifts - 1) {
        // start or end shift → full baseline team
        team = [...startEndTeam];
      } else {
        // middle shift → rotate but ≥ minimum required
        team = [];
        for (let i = 0; i < minInv; i++) {
          team.push(invigilators[(invIndex + i + s) % invigilators.length]);
        }
      }

      schedule.push({
        Date: date,
        Time: shiftStart + "-" + shiftEnd,
        Room: name,
        Invigilators: team.join(", ")
      });
    }
  });

  lastSchedule = schedule;

  // render
  let html = `<table class="table-auto border-collapse border border-gray-400 w-full">
                <thead>
                  <tr class="bg-gray-200">
                    <th class="border px-2">Date</th>
                    <th class="border px-2">Time</th>
                    <th class="border px-2">Room</th>
                    <th class="border px-2">Invigilators</th>
                  </tr>
                </thead>
                <tbody>`;
  schedule.forEach(r => {
    html += `<tr>
               <td class="border px-2">${r.Date}</td>
               <td class="border px-2">${r.Time}</td>
               <td class="border px-2">${r.Room}</td>
               <td class="border px-2">${r.Invigilators}</td>
             </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("output").innerHTML = html;
}

function exportExcel() {
  if (lastSchedule.length === 0) {
    alert("Please generate a timetable first.");
    return;
  }
  let ws = XLSX.utils.json_to_sheet(lastSchedule);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Timetable");
  XLSX.writeFile(wb, "InvigilationTimetable.xlsx");
}
</script>
</body>
</html>
