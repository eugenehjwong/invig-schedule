<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invigilation Timetable Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="p-6 bg-gray-100">
  <h1 class="text-2xl font-bold mb-4">Invigilation Timetable Generator</h1>

  <!-- Inputs -->
  <div class="grid grid-cols-2 gap-4 mb-6">
    <div>
      <label class="block mb-1 font-semibold">Exam Date</label>
      <input type="text" id="examDate" placeholder="dd-mm-yyyy" class="border p-2 w-full rounded">
    </div>
    <div>
      <label class="block mb-1 font-semibold">Exam Start Time</label>
      <input type="text" id="examStart" placeholder="HHMM (24h, no colon)" class="border p-2 w-full rounded">
    </div>
    <div>
      <label class="block mb-1 font-semibold">Paper Duration (min)</label>
      <input type="number" id="examDuration" class="border p-2 w-full rounded">
    </div>
    <div>
      <label class="block mb-1 font-semibold">Shift Length (min)</label>
      <input type="number" id="shiftLength" class="border p-2 w-full rounded">
    </div>
  </div>

  <div class="mb-6">
    <label class="block mb-1 font-semibold">Invigilators (comma separated)</label>
    <textarea id="invigilators" rows="3" class="border p-2 w-full rounded"></textarea>
  </div>

  <div class="mb-6">
    <label class="block mb-1 font-semibold">Rooms (format: Name,Candidates)</label>
    <textarea id="rooms" rows="3" class="border p-2 w-full rounded"
              placeholder="Hall A,200&#10;Hall B,80"></textarea>
  </div>

  <div class="flex space-x-4 mb-6">
    <button onclick="generateTimetable()" class="bg-blue-600 text-white px-4 py-2 rounded">Generate</button>
    <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded">Export Excel</button>
  </div>

  <!-- Output -->
  <div id="output" class="overflow-x-auto"></div>

<script>
function parseTime(str) {
  let h = parseInt(str.substring(0,2), 10);
  let m = parseInt(str.substring(2), 10);
  return h*60 + m;
}

function formatTime(totalMin) {
  let h = Math.floor(totalMin / 60) % 24; // wrap hours around 24
  let m = totalMin % 60;
  let hh = h < 10 ? "0" + h : h;
  let mm = m < 10 ? "0" + m : m;
  return hh + mm;
}

let lastSchedule = [];

function generateTimetable() {
  const date = document.getElementById("examDate").value.trim();
  const startTime = document.getElementById("examStart").value.trim();
  const examDuration = parseInt(document.getElementById("examDuration").value, 10);
  const shiftLength = parseInt(document.getElementById("shiftLength").value, 10);
  let invigilators = document.getElementById("invigilators").value.split(",").map(x=>x.trim()).filter(Boolean);
  const roomsInput = document.getElementById("rooms").value.trim().split("\n");

  if (!date || !startTime || !examDuration || !shiftLength || invigilators.length === 0 || roomsInput.length === 0) {
    alert("Please fill in all inputs.");
    return;
  }

  // Prepare rooms
  let rooms = [];
  for (let line of roomsInput) {
    let [name,cands] = line.split(",");
    if(!name) continue;
    let candidates = parseInt(cands,10)||0;
    let minReq = Math.ceil(candidates/40);
    let deployed = 2*minReq; // double minimum rule
    rooms.push({name:name.trim(), candidates, minReq, deployed});
  }

  // Calculate shifts
  const startMin = parseTime(startTime);
  const examEnd = startMin + examDuration;
  const numShifts = Math.ceil(examDuration/shiftLength);
  let shifts = [];
  for(let i=0;i<numShifts;i++){
    let s = startMin + i*shiftLength;
    let e = Math.min(s + shiftLength, examEnd); // last shift may be shorter
    shifts.push({start:s, end:e});
  }

  // Assign invigilators
  let assignment = {};
  let invIndex = 0;

  rooms.forEach(r=>{
    assignment[r.name] = [];
    if(invigilators.length < r.deployed){
      alert(`Not enough invigilators for ${r.name}. Need ${r.deployed}, have ${invigilators.length}.`);
      return;
    }
    let fullTeam = invigilators.slice(invIndex, invIndex + r.deployed);
    invIndex += r.deployed;

    let groupA = fullTeam.slice(0,r.minReq);
    let groupB = fullTeam.slice(r.minReq);

    for(let s=0;s<shifts.length;s++){
      if(s===0 || s===shifts.length-1){
        // Start or End → full team
        assignment[r.name].push([...fullTeam]);
      } else {
        // Middle → alternate groupA/groupB
        if((s-1)%2===0){
          assignment[r.name].push([...groupA]);
        } else {
          assignment[r.name].push([...groupB]);
        }
      }
    }
  });

  lastSchedule = {rooms, shifts, assignment, date};

  // Render table
  let table = "<table class='table-auto border-collapse border border-gray-400 w-full bg-white'>";
  table += "<thead><tr><th class='border px-2 py-1'>Date</th><th class='border px-2 py-1'>Time</th>";
  rooms.forEach(r=>table+="<th class='border px-2 py-1'>"+r.name+"</th>");
  table+="</tr></thead><tbody>";

  for(let i=0;i<shifts.length;i++){
    table+="<tr><td class='border px-2 py-1'>"+date+"</td>";
    table+="<td class='border px-2 py-1'>"+formatTime(shifts[i].start)+"-"+formatTime(shifts[i].end)+"</td>";
    rooms.forEach(r=>{
      table+="<td class='border px-2 py-1 whitespace-pre-line'>"+assignment[r.name][i].join("<br>")+"</td>";
    });
    table+="</tr>";
  }
  table+="</tbody></table>";
  document.getElementById("output").innerHTML = table;
}

function exportExcel() {
  if(!lastSchedule){
    alert("Generate timetable first!");
    return;
  }
  const table = document.querySelector("#output table");
  if(!table){
    alert("Generate timetable first!");
    return;
  }
  const wb = XLSX.utils.table_to_book(table,{sheet:"Timetable"});
  XLSX.writeFile(wb,"invigilation_timetable.xlsx");
}
</script>
</body>
</html>
