<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invigilation Timetable Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto bg-white shadow p-6 rounded">
    <h1 class="text-2xl font-bold mb-4">Invigilation Timetable Generator</h1>

    <!-- Input Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="font-semibold">Invigilators</label>
        <textarea id="invigilators" class="w-full border p-2 h-40" placeholder="One per line"></textarea>
      </div>
      <div>
        <label class="font-semibold">Rooms</label>
        <textarea id="rooms" class="w-full border p-2 h-40" placeholder="One per line"></textarea>
      </div>
      <div>
        <label class="font-semibold">Paper Timeslots</label>
        <textarea id="timeslots" class="w-full border p-2 h-40" placeholder="Format: YYYY-MM-DD HH:MM (start time only)&#10;e.g. 2025-10-05 09:00"></textarea>
      </div>
    </div>

    <!-- Options -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
      <div>
        <label class="font-semibold">Paper Duration (minutes)</label>
        <input id="paperDuration" type="number" value="180" class="w-full border p-2">
      </div>
      <div>
        <label class="font-semibold">Invigilator Shift Length (minutes)</label>
        <input id="shiftLength" type="number" value="90" class="w-full border p-2">
      </div>
      <div>
        <label class="font-semibold">Max Papers per Invigilator</label>
        <input id="maxPerInvigilator" type="number" class="w-full border p-2" placeholder="Leave blank for no limit">
      </div>
    </div>

    <div class="mt-4">
      <label><input type="checkbox" id="avoidConsecutive" class="mr-2">Avoid consecutive shifts</label>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-2 mt-4">
      <button id="sampleBtn" class="bg-gray-300 px-4 py-2 rounded">Load Sample Data</button>
      <button id="generateBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Generate Timetable</button>
      <button id="balanceBtn" class="bg-purple-500 text-white px-4 py-2 rounded">Check Balance</button>
      <button id="exportBtn" class="bg-green-500 text-white px-4 py-2 rounded">Export Excel</button>
      <button id="downloadCSVBtn" class="bg-yellow-500 text-white px-4 py-2 rounded">Export CSV</button>
    </div>

    <!-- Preview -->
    <div class="mt-6">
      <h2 class="text-xl font-semibold">Generated Timetable Preview</h2>
      <table id="timetable" class="table-auto border-collapse border w-full mt-2"></table>
    </div>

    <!-- Balance -->
    <div class="mt-6">
      <h2 class="text-xl font-semibold">Invigilation Counts</h2>
      <div id="countsArea" class="p-2 bg-gray-50 border mt-2"></div>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
function parseLines(id){ return $(id).value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }

// Safe datetime parsing
function parseDateTime(str){
  let [date,time]=str.split(" ");
  if(!time) time="00:00";
  const [y,m,d]=date.split("-").map(Number);
  const [hh,mm]=time.split(":").map(Number);
  return new Date(y,m-1,d,hh,mm);
}
function formatDateTime(d){
  const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function addMinutes(timeStr,mins){
  const d=parseDateTime(timeStr);
  d.setMinutes(d.getMinutes()+mins);
  return formatDateTime(d);
}

// Sample Data
function loadSample(){
  $('invigilators').value=['Alice','Bob','Chen','Deepa','Evan'].join('\n');
  $('rooms').value=['Hall A','Hall B'].join('\n');
  $('timeslots').value=['2025-10-05 09:00','2025-10-06 14:00'].join('\n');
}
$('sampleBtn').addEventListener('click',loadSample);

// Generate Timetable
function generateTimetable(){
  const invigilators=parseLines('invigilators');
  const rooms=parseLines('rooms');
  const slots=parseLines('timeslots');
  const paperDur=parseInt($('paperDuration').value)||180;
  const shiftLen=parseInt($('shiftLength').value)||90;
  const avoidConsec=$('avoidConsecutive').checked;
  const maxPer=parseInt($('maxPerInvigilator').value)||Infinity;
  if(!invigilators.length||!rooms.length||!slots.length) return alert('Fill all lists.');

  // Generate shifts
  let shifts=[];
  for(const slot of slots){
    let start=slot;
    let used=0;
    while(used<paperDur){
      let end=addMinutes(start,Math.min(shiftLen,paperDur-used));
      shifts.push(`${start} â€“ ${end}`);
      start=end;
      used+=shiftLen;
    }
  }

  // Assignment
  let counts={}; invigilators.forEach(i=>counts[i]=0);
  let table=shifts.map(()=>rooms.map(()=>''));  
  let pointer=0;
  for(let s=0;s<shifts.length;s++){
    for(let r=0;r<rooms.length;r++){
      let chosen=null;
      for(let k=0;k<invigilators.length;k++){
        let cand=invigilators[(pointer+k)%invigilators.length];
        if(counts[cand]>=maxPer) continue;
        if(avoidConsec && s>0){
          if(table[s-1].includes(cand)) continue;
        }
        chosen=cand; break;
      }
      if(!chosen) chosen=invigilators[pointer%invigilators.length];
      table[s][r]=chosen;
      counts[chosen]++;
      pointer++;
    }
  }
  renderTable(shifts,rooms,table);
  window.lastGenerated={shifts,rooms,table,counts};
}
$('generateBtn').addEventListener('click',generateTimetable);

// Render Table
function renderTable(shifts,rooms,table){
  const tbl=$('timetable'); tbl.innerHTML='';
  let thead='<tr><th class="border px-2 py-1 bg-slate-100">Shift / Room</th>';
  for(const r of rooms) thead+=`<th class="border px-2 py-1 bg-slate-100">${r}</th>`;
  thead+='</tr>';
  tbl.innerHTML=thead;
  for(let i=0;i<shifts.length;i++){
    let row=`<tr><th class="border px-2 py-1">${shifts[i]}</th>`;
    for(let j=0;j<rooms.length;j++){
      row+=`<td class="border px-2 py-1">${table[i][j]}</td>`;
    }
    row+='</tr>';
    tbl.innerHTML+=row;
  }
}

// Balance
$('balanceBtn').addEventListener('click',()=>{
  if(!window.lastGenerated) return;
  let c=window.lastGenerated.counts;
  $('countsArea').innerHTML=Object.entries(c).map(([k,v])=>`${k}: ${v}`).join('<br>');
});

// Excel Export
$('exportBtn').addEventListener('click',()=>{
  if(!window.lastGenerated) return;
  const {shifts,rooms,table}=window.lastGenerated;
  const wsData=[['Shift / Room',...rooms]];
  for(let i=0;i<shifts.length;i++) wsData.push([shifts[i],...table[i]]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb,ws,'Invigilation');
  XLSX.writeFile(wb,'invigilation.xlsx');
});

// CSV Export
$('downloadCSVBtn').addEventListener('click',()=>{
  if(!window.lastGenerated) return;
  const {shifts,rooms,table}=window.lastGenerated;
  let lines=[['Shift / Room',...rooms].join(',')];
  for(let i=0;i<shifts.length;i++) lines.push([shifts[i],...table[i]].join(','));
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='invigilation.csv';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body>
</html>