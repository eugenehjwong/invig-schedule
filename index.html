<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invigilation Timetable Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto bg-white shadow p-6 rounded">
    <h1 class="text-2xl font-bold mb-4">Invigilation Timetable Generator</h1>

    <!-- Input Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="font-semibold">Invigilators</label>
        <textarea id="invigilators" class="w-full border p-2 h-40" placeholder="One per line"></textarea>
      </div>
      <div>
        <label class="font-semibold">Rooms (format: RoomName,NumberOfInvigilators)</label>
        <textarea id="rooms" class="w-full border p-2 h-40" placeholder="Hall A,3&#10;Hall B,2"></textarea>
      </div>
      <div>
        <label class="font-semibold">Paper Timeslots</label>
        <textarea id="timeslots" class="w-full border p-2 h-40" placeholder="Format: dd-mm-yyyy HHMM&#10;e.g. 05-10-2025 0900"></textarea>
      </div>
    </div>

    <!-- Options -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
      <div>
        <label class="font-semibold">Paper Duration (minutes)</label>
        <input id="paperDuration" type="number" value="180" class="w-full border p-2">
      </div>
      <div>
        <label class="font-semibold">Invigilator Shift Length (minutes)</label>
        <input id="shiftLength" type="number" value="90" class="w-full border p-2">
      </div>
      <div>
        <label class="font-semibold">Max Papers per Invigilator</label>
        <input id="maxPerInvigilator" type="number" class="w-full border p-2" placeholder="Leave blank for no limit">
      </div>
    </div>

    <div class="mt-4">
      <label><input type="checkbox" id="avoidConsecutive" class="mr-2">Avoid consecutive shifts</label>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-2 mt-4 flex-wrap">
      <button id="sampleBtn" class="bg-gray-300 px-4 py-2 rounded">Load Sample Data</button>
      <button id="generateBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Generate Timetable</button>
      <button id="balanceBtn" class="bg-purple-500 text-white px-4 py-2 rounded">Check Balance</button>
      <button id="exportBtn" class="bg-green-500 text-white px-4 py-2 rounded">Export Excel</button>
      <button id="downloadCSVBtn" class="bg-yellow-500 text-white px-4 py-2 rounded">Export CSV</button>
    </div>

    <!-- Preview -->
    <div class="mt-6">
      <h2 class="text-xl font-semibold">Generated Timetable Preview</h2>
      <table id="timetable" class="table-auto border-collapse border w-full mt-2"></table>
    </div>

    <!-- Balance -->
    <div class="mt-6">
      <h2 class="text-xl font-semibold">Invigilation Counts</h2>
      <div id="countsArea" class="p-2 bg-gray-50 border mt-2"></div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const $ = id => document.getElementById(id);

  function parseLines(id) {
    return $(id).value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  }

  function parseDateTime(str) {
    let [date,time] = str.split(" ");
    if (!time) time="0000";
    const [d,m,y] = date.split("-").map(Number);
    const hh = parseInt(time.substring(0,2),10);
    const mm = parseInt(time.substring(2,4),10);
    return new Date(y,m-1,d,hh,mm);
  }

  function formatDateTime(d) {
    const pad=n=>String(n).padStart(2,"0");
    const date=`${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`;
    const time=`${pad(d.getHours())}${pad(d.getMinutes())}`;
    return {date,time};
  }

  function loadSample() {
    $('invigilators').value = ['Alice','Bob','Chen','Deepa','Evan'].join('\\n');
    $('rooms').value = ['Hall A,3','Hall B,2'].join('\\n');
    $('timeslots').value = ['05-10-2025 0900','06-10-2025 1430'].join('\\n');
  }

  function generateTimetable() {
    const invigilators=parseLines('invigilators');
    const roomLines=parseLines('rooms');
    const slots=parseLines('timeslots');
    const paperDur=parseInt($('paperDuration').value)||180;
    const shiftLen=parseInt($('shiftLength').value)||90;
    const avoidConsec=$('avoidConsecutive').checked;
    const maxPer=parseInt($('maxPerInvigilator').value)||Infinity;

    if(!invigilators.length||!roomLines.length||!slots.length) {
      alert('Fill all lists.');
      return;
    }

    let rooms=roomLines.map(line=>{
      let parts=line.split(',');
      let name=parts[0].trim();
      let num=(parts[1] && !isNaN(parts[1])) ? parseInt(parts[1]) : 1;
      if(num<=0) num=1;
      return {name, num};
    });

    let shifts=[];
    for(const slot of slots){
      let start=parseDateTime(slot);
      let used=0;
      while(used<paperDur){
        let end=new Date(start.getTime());
        end.setMinutes(end.getMinutes()+Math.min(shiftLen,paperDur-used));
        let {date:ds,time:ts}=formatDateTime(start);
        let {time:te}=formatDateTime(end);
        shifts.push({date:ds,range:`${ts}â€“${te}`});
        start=end;
        used+=shiftLen;
      }
    }

    let counts={}; invigilators.forEach(i=>counts[i]=0);
    let table=shifts.map(()=>rooms.map(()=>[]));

    let pointer=0;
    for(let s=0;s<shifts.length;s++){
      for(let r=0;r<rooms.length;r++){
        let needed=rooms[r].num;
        for(let n=0;n<needed;n++){
          let chosen=null;
          for(let k=0;k<invigilators.length;k++){
            let cand=invigilators[(pointer+k)%invigilators.length];
            if(counts[cand]>=maxPer) continue;
            if(avoidConsec && s>0){
              if(table[s-1][r].includes(cand)) continue;
            }
            if(table[s][r].includes(cand)) continue;
            chosen=cand; break;
          }
          if(!chosen) chosen=invigilators[pointer%invigilators.length];
          table[s][r].push(chosen);
          counts[chosen]++;
          pointer++;
        }
      }
    }

    renderTable(shifts,rooms,table);
    window.lastGenerated={shifts,rooms,table,counts};
  }

  function renderTable(shifts,rooms,table){
    const tbl=$('timetable'); tbl.innerHTML='';
    let thead='<tr><th class="border px-2 py-1 bg-slate-100">Date</th><th class="border px-2 py-1 bg-slate-100">Shift</th>';
    for(const r of rooms) thead+=`<th class="border px-2 py-1 bg-slate-100">${r.name}</th>`;
    thead+='</tr>';
    tbl.innerHTML=thead;
    for(let i=0;i<shifts.length;i++){
      let row=`<tr><td class="border px-2 py-1">${shifts[i].date}</td><td class="border px-2 py-1">${shifts[i].range}</td>`;
      for(let j=0;j<rooms.length;j++){
        row+=`<td class="border px-2 py-1">${table[i][j].join(", ")}</td>`;
      }
      row+='</tr>';
      tbl.innerHTML+=row;
    }
  }

  $('sampleBtn').addEventListener('click', loadSample);
  $('generateBtn').addEventListener('click', generateTimetable);
  $('balanceBtn').addEventListener('click', ()=>{
    if(!window.lastGenerated) return;
    let c=window.lastGenerated.counts;
    $('countsArea').innerHTML=Object.entries(c).map(([k,v])=>`${k}: ${v}`).join('<br>');
  });
  $('exportBtn').addEventListener('click', ()=>{
    if(!window.lastGenerated) return;
    const {shifts,rooms,table}=window.lastGenerated;
    const wsData=[['Date','Shift',...rooms.map(r=>r.name)]];
    for(let i=0;i<shifts.length;i++) wsData.push([shifts[i].date,shifts[i].range,...table[i].map(x=>x.join(", "))]);
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb,ws,'Invigilation');
    XLSX.writeFile(wb,'invigilation.xlsx');
  });
  $('downloadCSVBtn').addEventListener('click', ()=>{
    if(!window.lastGenerated) return;
    const {shifts,rooms,table}=window.lastGenerated;
    let lines=[['Date','Shift',...rooms.map(r=>r.name)].join(',')];
    for(let i=0;i<shifts.length;i++) lines.push([shifts[i].date,shifts[i].range,...table[i].map(x=>x.join(" "))].join(','));
    const blob=new Blob([lines.join('\\n')],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='invigilation.csv'; a.click();
    URL.revokeObjectURL(url);
  });
});
</script>
</body>
</html>
